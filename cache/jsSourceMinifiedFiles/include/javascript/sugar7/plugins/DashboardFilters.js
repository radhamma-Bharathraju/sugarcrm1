(function register(app){app.events.on('app:init',function init(){app.plugins.register('DashboardFilters',['view'],{onAttach:function(){this.on('init',function registerDashboardFilters(){});},initFiltersProperties:function(){this._activeFilterGroupId=false;this._hasGroupFilters=false;this._isGroupClicked=false;this._filterGroups={};this._filterGroupsView={};},invalidGroupSave:function(invalidGroups){this.markInvalidGroups(invalidGroups);},isValid:function(){let isValid=true;_.each(this._filterGroupsView,(group)=>{const groupValid=group.isValid();group.toggleGroupInvalid(!groupValid);if(isValid){isValid=groupValid;}});return isValid;},markInvalidGroups:function(groups){_.each(groups,(key)=>{const groupView=this._filterGroupsView[key];groupView.toggleGroupInvalid(true);});},destroyCurrentViews:function(){_.each(this._filterGroupsView,(group)=>{if(group&&_.isFunction(group.dispose)){group.dispose();}});this._filterGroupsView={};},createGroup:function(groupId,groupMeta,isSelected){this._filterGroups[groupId]=groupMeta;if(this.layout instanceof app.view.Layout&&_.isArray(this.layout.currentUserRestrictedGroups)){groupMeta.currentUserRestrictedGroup=_.contains(this.layout.currentUserRestrictedGroups,groupId);}
if(this._editMode&&isSelected){this.context.trigger('dashboard-filter-group-selected',groupId);this._activeFilterGroupId=groupId;}
this.createGroupFilter(groupId,groupMeta);},createGroupFilter:function(groupId,groupMeta){const widgetNo=Object.keys(this._filterGroups).length;const filterWidget=app.view.createView({type:'dashboard-filter-group-widget',module:'Home',editMode:this._editMode,groupId,groupMeta,widgetNo,});filterWidget.render();this.$('[data-container="group-filters-container"]').append(filterWidget.$el);this._filterGroupsView[groupId]=filterWidget;},handleDashboardFilters:function(filterGroups){this._activeFilterGroupId=false;this.destroyCurrentViews();this._filterGroups=filterGroups;if(!_.isEmpty(this._filterGroups)){this._activeFilterGroupId=_.first(_.keys(this._filterGroups));}
_.each(this._filterGroups,function createGroup(groupMeta,groupId){this.createGroup(groupId,groupMeta,groupId===this._activeFilterGroupId);},this);if(this._editMode){if(_.isEmpty(this._filterGroups)){this._createNewGroup();}}
this.notifyGroupsUpdated();},notifyGroupsUpdated:function(){this.context.trigger('filter-groups-updated',this._filterGroups,this._activeFilterGroupId);},notifyGroupsSelected:function(){this._isGroupClicked=true;this.context.trigger('filter-groups-updated',this._filterGroups,this._activeFilterGroupId,this._isGroupClicked);},onDetach:function(){this.destroyCurrentViews();},});});})(SUGAR.App);