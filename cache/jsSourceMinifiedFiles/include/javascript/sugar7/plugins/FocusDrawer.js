(function(app){app.events.on('app:init',function(){app.plugins.register('FocusDrawer',['view','field'],{focusIconEnabled:false,onAttach:function(component){component.off('render');component.on('render',function(){this.focusIconEnabled=this.checkFocusAvailability();if(this.view){if(this.focusIconEnabled){this.initFocusIcon();}
this.initFocusLink();this.handleRecordTitleDrag();}});},checkFocusLinkAvailability:function(){return this.$el.closest('.agent_workbench_dashboard, .console_dashboard, #side-drawer').length>0;},checkFocusAvailability:function(){var focusDrawerIsEnabled=app.utils.isTruthy(app.config.enableLinkToDrawer);var fieldIsValid=this.view&&_.isFunction(this.getFocusContextModule)&&_.isFunction(this.getFocusContextModelId)&&(!this.def||_.isUndefined(this.def.enableFocusIcon)||this.def.enableFocusIcon===true);var layoutIsValid=this._checkLayoutFocusDrawerAccess();return focusDrawerIsEnabled&&(!this.view||fieldIsValid)&&!_.isEmpty(app.sideDrawer)&&layoutIsValid&&!this.isBWCLink();},isBWCLink:function(){const link=this.$el.find('a[data-link-target="focus"]');if(link.length&&link.attr('href')){return link.attr('href').includes('#bwc/');}
return false;},enableFocusDrawer:function(){if(this.focusIconEnabled){this.initFocusIcon();}else{this.$('.sicon-focus-drawer').hide();}
this.initFocusLink();},initFocusLink:function(){let links=this.$el.find('a[data-link-target="focus"]');links.off('click.focus').on('click.focus',_.bind(this.handleRecordLink,this));},initFocusIcon:function(){var relateFieldContainer=this.$el.find('.relate-field-container');var focusIconContainer=relateFieldContainer.find('.focus-icon-container');var isContainerHidden=focusIconContainer.hasClass('hide');if(isContainerHidden&&this.value){focusIconContainer.toggleClass('hide');var focusIcon=focusIconContainer.find('.focus-icon');focusIcon.click(_.bind(this.handleFocusIcon,this));focusIcon.keyup(_.bind(this.handleKeyboardClick,this));}},handleFocusIcon:function(evt){evt.preventDefault();evt.stopPropagation();this.handleFocusClick('dashboard',$(evt.target));},handleRecordLink:function(evt){if(!this.checkFocusLinkAvailability()||this.isDragging){return;}
evt.preventDefault();evt.stopPropagation();this.handleFocusClick('record',$(evt.target));},handleRecordTitleDrag:function(){let self=this;self.isDragging=false;if(self.$el.closest('.dashlet-header')){let $draggable=self.$el.closest('.grid-stack-item.ui-draggable');if($draggable){$draggable.off('mousedown.link');$draggable.on('mousedown.link',function(e){self.isDragging=false;});$draggable.off('dragstart.link');$draggable.on('dragstart.link',function(e){self.isDragging=true;});}}},handleFocusClick:function(contentType,$el){if((contentType==='dashboard'&&this.focusIconEnabled)||contentType==='record'){var focusContext=this.getFocusContext(contentType,$el);if(!focusContext.context.module){focusContext.context.module=this.module;}
this.openFocusDrawer(focusContext,$el);}},handleKeyboardClick:function(e){if(e.type==='keyup'&&e.originalEvent.key==='Enter'){this.handleFocusClick('dashboard',e);}},getFocusContext:function(contentType,$el){if(contentType==='record'){return{layout:'record',dashboardName:this.getFocusContextTitle($el),context:{layout:'record',name:'record-drawer',contentType:contentType,module:$el.data('module'),modelId:$el.data('model-id'),dataTitle:this.getDataTitle('LBL_RECORD'),parentContext:this.context,baseModelId:this.model.get('id'),fieldDefs:_.isFunction(this.getFocusContextFieldDefs)?this.getFocusContextFieldDefs():this.fieldDefs}};}else{return{layout:'row-model-data',dashboardName:this.value,context:{layout:'focus',contentType:contentType,module:_.isFunction(this.getFocusContextModule)?this.getFocusContextModule():'',modelId:_.isFunction(this.getFocusContextModelId)?this.getFocusContextModelId():'',dataTitle:this.getDataTitle('LBL_FOCUS_DRAWER_DASHBOARD'),parentContext:this.context,fieldDefs:this.fieldDefs,baseModelId:this.model.get('id'),evtSource:$el,disableRecordSwitching:this._getDisableRecordSwitching()}};}},getDataTitle:function(term){let moduleNameSingular=app.lang.get('LBL_MODULE_NAME_SINGULAR',this.module)||this.module;let moduleMeta=app.metadata.getModule(this.module);let labelColor=(moduleMeta)?`label-module-color-${moduleMeta.color}`:`label-${this.module}`;return{module:moduleNameSingular,view:app.lang.get(term),name:this.value,labelColor:labelColor};},_getDisableRecordSwitching:function(){return this.disableFocusDrawerRecordSwitching||this.def.disableFocusDrawerRecordSwitching||false;},openFocusDrawer:function(context,$el){if(app.sideDrawer){var drawerIsOpen=app.sideDrawer.isOpen();var drawerContext=app.sideDrawer.currentContextDef;if(drawerIsOpen&&_.isEqual(context,drawerContext)){return;}
var sideDrawerClick=!!this.$el&&(this.$el.closest('#side-drawer').length>0);app.sideDrawer.open(context,null,sideDrawerClick,$el);}},_checkLayoutFocusDrawerAccess:function(){var currLayout=this.view?this.view.layout:this.layout;while(currLayout){if(currLayout.disableFocusDrawer){return false;}
currLayout=currLayout.layout;}
return true;}});});})(SUGAR.App);